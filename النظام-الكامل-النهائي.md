# ๐ฏ ุงููุธุงู ุงููุงูู - ุงูุฏููู ุงูููุงุฆู

## โจ ุงูู Flow ุงููุงูู

### 1๏ธโฃ Order ููุตู ูู Shopify
```
Shopify Order Created
    โ
Webhook โ api/shopify/webhook-handler.js
    โ
ูุญูุธ Order ูู Database (status: pending)
    โ
ูุจุนุช ุฑุณุงูุฉ WhatsApp ูููุง Buttons:
  [โ ุชุฃููุฏ] [โ ุฅูุบุงุก]
```

---

### 2๏ธโฃ ูู ุงูุนููู ูุฑุฏุด ุจุนุฏ ุณุงุนุฉ
```
Cron Job ูุดุชุบู ูู 15 ุฏูููุฉ
    โ
ูุฏูุฑ ุนูู Orders pending ูู ุณุงุนุฉ
    โ
ูุจุนุช ุฑุณุงูุฉ ุชุฐููุฑ:
"ูุณู ูุณุชูููู ุฑุฏู ุนุดุงู ูุฃูุฏ ุงูุทูุจ"
    โ
ูุน ููุณ ุงูู Buttons: [โ ุชุฃููุฏ] [โ ุฅูุบุงุก]
```

---

### 3๏ธโฃ ูู ุงูุนููู ุถุบุท "ุชุฃููุฏ"
```
WhatsApp Webhook โ api/webhook.js
    โ
ูุณุชูุจู Button Click (confirm_ORDER_ID)
    โ
ูุญุฏุซ Order ูู Database (status: confirmed)
    โ
ูุญุฏุซ Order ูู Shopify:
  - ูุถูู Tag: "whatsapp-confirmed"
  - ูุถูู Note: "ุชู ุงูุชุฃููุฏ ุนุจุฑ WhatsApp"
  - ูุนูู Fulfill ููู Order โ
    โ
ูุจุนุช ุฑุณุงูุฉ ุชุฃููุฏ ููุนููู:
"โ ุดูุฑุงู ูุชุฃููุฏู! ูุญู ุงูุขู ูุฌูุฒ ุทูุจู..."
```

---

### 4๏ธโฃ ูู ุงูุนููู ุถุบุท "ุฅูุบุงุก"
```
WhatsApp Webhook โ api/webhook.js
    โ
ูุณุชูุจู Button Click (cancel_ORDER_ID)
    โ
ูุชุญูู: ูู Order ููุบู ูุจู ูุฏู โ ูุฑูุถ
    โ
ูุญุฏุซ Order ูู Database (status: cancelled)
    โ
ููุบู Order ูู Shopify
    โ
ูุจุนุช ุฑุณุงูุฉ ุฅูุบุงุก ููุนููู:
"โ ุชู ุฅูุบุงุก ุทูุจู. ููููู ุงูุทูุจ ูุฑุฉ ุฃุฎุฑู..."
```

---

## ๐ ุงูุฅุนุฏุงุฏ ุงููุงูู

### ุงูุฎุทูุฉ 1: Database Setup

ููุฐ ุงูู SQL ุฏู ูู Supabase:

```sql
-- Add reminder and followup columns
ALTER TABLE shopify_orders 
ADD COLUMN IF NOT EXISTS reminder_sent_at TIMESTAMPTZ;

ALTER TABLE shopify_orders 
ADD COLUMN IF NOT EXISTS followup_sent_at TIMESTAMPTZ;

-- Add indexes
CREATE INDEX IF NOT EXISTS idx_orders_reminder 
ON shopify_orders(confirmation_status, reminder_sent_at, created_at)
WHERE confirmation_status = 'pending' AND reminder_sent_at IS NULL;

CREATE INDEX IF NOT EXISTS idx_orders_followup 
ON shopify_orders(confirmation_status, followup_sent_at, confirmed_at)
WHERE confirmation_status = 'confirmed' AND followup_sent_at IS NULL;
```

**ููู:**
1. Supabase Dashboard โ SQL Editor
2. ุงูุตู ุงูููุฏ
3. Run

---

### ุงูุฎุทูุฉ 2: Vercel Environment Variables

ูู Vercel Dashboard โ Settings โ Environment Variables:

```
Name: CRON_SECRET
Value: cron_secret_2024_xyz
```

(ุงุณุชุฎุฏู ุฃู ูููุฉ ุณุฑ ูููุฉ)

---

### ุงูุฎุทูุฉ 3: Shopify Webhooks

ูู Shopify Admin โ Settings โ Notifications โ Webhooks:

```
Event: Order creation
URL: https://wahtsapp2.vercel.app/api/shopify/webhook-handler
Format: JSON
```

---

### ุงูุฎุทูุฉ 4: WhatsApp Webhook

ูู Meta Developer Console โ WhatsApp โ Configuration:

```
Callback URL: https://wahtsapp2.vercel.app/api/webhook
Verify Token: whatsapp_crm_2024

Subscribe to:
  โ messages
  โ message_status
```

---

## ๐งช ุงุฎุชุจุงุฑ ุงููุธุงู

### Test 1: Order Confirmation

```bash
# 1. ุงุนูู test order ูู Shopify
# 2. ุงูุชุธุฑ ุงูุฑุณุงูุฉ ุนูู WhatsApp
# 3. ุงุถุบุท "ุชุฃููุฏ"
# 4. ุชุฃูุฏ ูู:
#    - ูุตูู ุฑุณุงูุฉ ุงูุชุฃููุฏ
#    - Order ูู Shopify: Fulfilled โ
#    - Order ูู Database: confirmed
```

### Test 2: Order Cancellation

```bash
# 1. ุงุนูู test order ูู Shopify
# 2. ุงูุชุธุฑ ุงูุฑุณุงูุฉ ุนูู WhatsApp
# 3. ุงุถุบุท "ุฅูุบุงุก"
# 4. ุชุฃูุฏ ูู:
#    - ูุตูู ุฑุณุงูุฉ ุงูุฅูุบุงุก
#    - Order ูู Shopify: Cancelled
#    - Order ูู Database: cancelled
```

### Test 3: Reminder Message

```bash
# 1. ุงุนูู test order ูู Shopify
# 2. ูุง ุชุฑุฏ ุนูู ุงูุฑุณุงูุฉ
# 3. ุงูุชุธุฑ ุณุงุนุฉ
# 4. ุชุฃูุฏ ูู:
#    - ูุตูู ุฑุณุงูุฉ ุงูุชุฐููุฑ
#    - ุงูุฑุณุงูุฉ ูููุง ููุณ ุงูู Buttons
```

---

## ๐ ูุชุงุจุนุฉ ุงููุธุงู

### ูู Vercel Logs:

```
โ Order confirmation sent
โ Button clicked: confirm_123
โ Shopify order confirmed
โ Shopify order fulfilled
โ Order updated successfully
```

### ูู Supabase:

```sql
-- ุดูู ุขุฎุฑ Orders
SELECT 
  shopify_order_number,
  confirmation_status,
  created_at,
  reminder_sent_at,
  confirmed_at,
  cancelled_at
FROM shopify_orders
ORDER BY created_at DESC
LIMIT 10;
```

---

## ๐จ ุชุฎุตูุต ุงูุฑุณุงุฆู

### ุฑุณุงูุฉ ุงูุชุฃููุฏ:

ูู CRM โ Settings โ Template Settings:

```
Confirmation Message:
"ุชู ุชุฃููุฏ ุทูุจู ุจูุฌุงุญ!"
```

### ุฑุณุงูุฉ ุงูุฅูุบุงุก:

```
Cancellation Message:
"ุชู ุฅูุบุงุก ุทูุจู."
```

### ุฑุณุงูุฉ ุงูุชุฐููุฑ:

ุนุฏู ูู `api/cron/send-order-followup.js`:

```javascript
const reminderMessage = `ูุฑุญุจุงู ${contact.name} ๐

[ุฑุณุงูุชู ุงููุฎุตุตุฉ ููุง]

๐ฅ *ูู ูุนุชูุฏ ุงูุทูุจ ููุจุฏุฃ ุงูุชุฌููุฒุ*`;
```

---

## โ๏ธ ุงูุฅุนุฏุงุฏุงุช ุงููุชูุฏูุฉ

### ุชุบููุฑ ููุช ุงูุชุฐููุฑ (ูู ุณุงุนุฉ ูู 2 ุณุงุนุฉ):

ูู `api/cron/send-order-followup.js`:

```javascript
// ุจุฏู:
const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();

// ุงุณุชุฎุฏู:
const twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString();
```

### ุชุบููุฑ ุชูุฑุงุฑ ุงูู Cron (ูู 15 ุฏูููุฉ ูู 30 ุฏูููุฉ):

ูู `vercel.json`:

```json
"crons": [
  {
    "path": "/api/cron/send-order-followup",
    "schedule": "*/30 * * * *"
  }
]
```

---

## ๐ง ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ูููุด ุฑุณุงุฆู ุจุชูุตู

**ุงูุญู:**
1. ุชุฃูุฏ ูู WhatsApp Token ุตุงูุญ
2. ุชุฃูุฏ ูู WhatsApp Webhook ูุชูุตู
3. ุดูู Vercel Logs

### ุงููุดููุฉ: Buttons ูุด ุดุบุงูุฉ

**ุงูุญู:**
1. ุชุฃูุฏ ูู Subscribe to "messages" ูู Meta
2. ุชุฃูุฏ ูู Webhook URL ุตุญูุญ
3. ุดูู `ุญู-ูุดููุฉ-ุงูุจูุชููุงุช.md`

### ุงููุดููุฉ: Order ูุด ุจูุชุญุฏุซ ูู Shopify

**ุงูุญู:**
1. ุชุฃูุฏ ูู Shopify Access Token ุตุงูุญ
2. ุชุฃูุฏ ูู Shopify Connection active
3. ุดูู Vercel Logs ููุฃุฎุทุงุก

### ุงููุดููุฉ: Reminder ูุด ุจูุชุจุนุช

**ุงูุญู:**
1. ุชุฃูุฏ ูู `reminder_sent_at` column ููุฌูุฏ
2. ุชุฃูุฏ ูู `CRON_SECRET` ูู Vercel
3. ุชุฃูุฏ ูู Cron Job ููุนู

---

## ๐ Checklist ุงูููุงุฆู

ูุจู ูุง ุชุดุบู ุงููุธุงู:

- [ ] Database columns ูุถุงูุฉ (reminder_sent_at, followup_sent_at)
- [ ] Indexes ููุฌูุฏุฉ
- [ ] CRON_SECRET ูู Vercel
- [ ] Shopify Webhook ูุถุงู
- [ ] WhatsApp Webhook ูุชูุตู
- [ ] WhatsApp Token ุตุงูุญ (Permanent)
- [ ] Shopify Connection active
- [ ] ุงุฎุชุจุฑุช Order confirmation
- [ ] ุงุฎุชุจุฑุช Order cancellation
- [ ] ุงุฎุชุจุฑุช Reminder message

---

## ๐ฏ ุงูุฎูุงุตุฉ

**ุงููุธุงู ุจูุนูู:**
- โ ูุจุนุช ุฑุณุงูุฉ Order ูุน Buttons
- โ ูุจุนุช ุชุฐููุฑ ูู ูููุด ุฑุฏ ุจุนุฏ ุณุงุนุฉ
- โ ูุฃูุฏ Order ูู Shopify + Fulfill
- โ ููุบู Order ูู Shopify
- โ ูููุน ุงูุฅูุบุงุก ุงููุชูุฑุฑ
- โ ูุจุนุช ุฑุณุงุฆู ุชุฃููุฏ/ุฅูุบุงุก ูุฎุตุตุฉ

**ูู ุญุงุฌุฉ ุชููุงุฆูุฉ:**
- ูููุด ุญุงุฌุฉ ูุฏูู
- Cron Job ูุดุชุบู ููุญุฏู
- Webhooks ุชุดุชุบู ุชููุงุฆูุงู
- Shopify ูุชุญุฏุซ ุชููุงุฆูุงู

---

## ๐ ุงููููุงุช ุงููููุฉ

```
api/
  webhook.js                      โ WhatsApp webhook (button clicks)
  shopify/
    webhook-handler.js            โ Shopify webhook (new orders)
  cron/
    send-order-followup.js        โ Reminder cron job

add-followup-column.sql           โ Database setup
vercel.json                       โ Cron configuration
```

---

**๐ ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู!**

ูู ูู ุฃู ูุดููุฉุ ุดูู:
- `ุญู-ูุดููุฉ-ุงูุจูุชููุงุช.md`
- `ุฏููู-ุงููุชุงุจุนุฉ-ุงูุชููุงุฆูุฉ.md`
- Vercel Logs
- Supabase Logs

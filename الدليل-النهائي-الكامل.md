# ๐ฏ ุงูุฏููู ุงูููุงุฆู ุงููุงูู - Moon WhatsApp CRM

## ุงููุธุงู ุงููุงูู ุจุฏูู n8n

---

## ๐ ุงูุฎุทูุฉ 1: ุฅูุดุงุก Template ูู Meta (ูุฑุฉ ูุงุญุฏุฉ)

### 1. ุงูุชุญ Meta Developer Console
https://developers.facebook.com

### 2. ุงุฎุชุงุฑ ุงูุชุทุจูู โ WhatsApp โ Message Templates โ Create Template

### 3. ุงููุฃ ุงูุจูุงูุงุช:

**Name:** `moon_order_confirmation`
**Category:** `TRANSACTIONAL`
**Language:** `Arabic (ar)`

**Header:**
```
Type: Text
Text: ๐ ุฃููุงู ุจู ูู Moon โจ
```

**Body:**
```
ุดูุฑุงู ูุงุฎุชูุงุฑู ููุงุ ุทูุจู ูุตููุง ูุจุงูุชุธุงุฑ ุชุฃููุฏู ููุจุฏุก ูู ุชุฌููุฒู ููุฑุงู.

๐งพ *ุฑูู ุงูุทูุจ:* #{{1}}

๐งฃ *ุงููุทุน ุงููุฎุชุงุฑุฉ:*
{{2}}

ูููููููููููููููููููููููููููููููููููููููู
๐ฐ *ุชูุงุตูู ุงููุงุชูุฑุฉ:*
๐ธ ุงููุฌููุน ุงููุฑุนู: {{3}} EGP
๐ ูุตุงุฑูู ุงูุดุญู: {{4}} EGP
ูููููููููููููููููููููููููููููููููููููููู
๐ต *ุงูุฅุฌูุงูู ุงูููุงุฆู: {{5}} EGP*
ูููููููููููููููููููููููููููููููููููููููู

๐ *ุจูุงูุงุช ุงูุชูุตูู:*
๐ค ุงููุณุชูู: {{6}}
๐ ุงูุนููุงู: {{7}}

๐ฅ *ูู ูุนุชูุฏ ุงูุทูุจ ููุจุฏุฃ ุงูุชุฌููุฒุ*
```

**Buttons:**
```
Type: Quick Reply

Button 1: โ ุชุฃููุฏ
Button 2: โ ุฅูุบุงุก
```

**Footer:**
```
ูุชููู ููู ุชุฌุฑุจุฉ ูููุฒุฉ ูุน Moon ๐
```

### 4. Submit for Review
- ุงูุชุธุฑ 24 ุณุงุนุฉ ููููุงููุฉ
- ุจุนุฏ ุงูููุงููุฉุ Template ุฌุงูุฒ ููุงุณุชุฎุฏุงู

---

## ๐ ุงูุฎุทูุฉ 2: ุฅุนุฏุงุฏ Shopify Webhooks

### 1. ุงูุชุญ Shopify Admin
```
Settings โ Notifications โ Webhooks
```

### 2. ุฃุถู Webhook ููู Orders:

**Event:** `Order creation`
**Format:** `JSON`
**URL:** `https://wahtsapp2.vercel.app/api/shopify/webhook-handler`

### 3. ุงุญูุธ

---

## ๐ ุงูุฎุทูุฉ 3: ุฑุจุท Shopify ุจุงููุธุงู

### ุงูุทุฑููุฉ 1: OAuth (Professional)

1. ุงูุชุญ Dashboard: https://wahtsapp2.vercel.app
2. Settings โ Shopify Integration
3. ุงุถุบุท "Connect with OAuth"
4. ูุงูู ูู Shopify
5. ุชู!

### ุงูุทุฑููุฉ 2: Manual Token (ุฃุณุฑุน)

1. Shopify โ Settings โ Apps โ Develop apps
2. Create app
3. Configure scopes: `read_orders`, `write_orders`
4. Install app
5. Reveal token
6. ูู Dashboard: Settings โ Shopify โ Manual Token
7. ุงูุตู Token โ Connect

---

## ๐ ุงูุฎุทูุฉ 4: ุฅุนุฏุงุฏ WhatsApp Webhook

### 1. Meta Developer Console
https://developers.facebook.com

### 2. WhatsApp โ Configuration โ Webhook

**Callback URL:** `https://wahtsapp2.vercel.app/api/webhook`
**Verify Token:** `whatsapp_crm_2024`

### 3. Subscribe to:
- โ messages
- โ message_status

---

## ๐ฏ ููู ูุดุชุบู ุงููุธุงู:

### ุงูุณููุงุฑูู ุงููุงูู:

```
1. ุนููู ูุนูู Order ูู Shopify
   โ
2. Shopify ูุจุนุช Webhook ูููุธุงู
   โ
3. ุงููุธุงู ูุณุชูุจู Order ููุญูุธู ูู Database
   โ
4. ุงููุธุงู ูุจุนุช WhatsApp Message ุชููุงุฆูุงู:
   - ูู Template ูุนุชูุฏ โ ูุณุชุฎุฏู Template
   - ูู Template ูุด ูุนุชูุฏ โ ูุณุชุฎุฏู Interactive Message
   โ
5. ุงูุนููู ูุณุชูู ุฑุณุงูุฉ ูููุง:
   - ุชูุงุตูู ุงูุทูุจ ูุงููุฉ
   - Buttons: โ ุชุฃููุฏ | โ ุฅูุบุงุก
   โ
6. ุงูุนููู ูุถุบุท "โ ุชุฃููุฏ"
   โ
7. WhatsApp ูุจุนุช Webhook ูููุธุงู
   โ
8. ุงููุธุงู ูุนุฑู Button ID
   โ
9. ุงููุธุงู ูุญุฏุซ Shopify Order:
   - ูุถูู Tag: "whatsapp-confirmed"
   - ูุถูู Note: "ุชู ุงูุชุฃููุฏ ุนุจุฑ WhatsApp"
   โ
10. ุงููุธุงู ูุจุนุช ุฑุณุงูุฉ ุชุฃููุฏ ููุนููู:
    "โ ุชู ุชุฃููุฏ ุทูุจู ุจูุฌุงุญ!"
   โ
11. Order Status ูุชุญุฏุซ ูู Database
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ:

### Test 1: ุงุนูู Order ูู Shopify

1. ุงูุชุญ Shopify Store
2. ุงุนูู Order ุฌุฏูุฏ
3. ุญุท ุฑูู ููุจุงูู ุตุญูุญ
4. Complete Order

**ุงูููุฑูุถ ูุญุตู:**
- โ Order ูุชุญูุธ ูู Database
- โ ุฑุณุงูุฉ WhatsApp ุชูุตู ููุนููู
- โ ุงูุฑุณุงูุฉ ูููุง Buttons

### Test 2: ุงุถุบุท "ุชุฃููุฏ"

1. ุงูุชุญ WhatsApp
2. ุงุถุบุท "โ ุชุฃููุฏ"

**ุงูููุฑูุถ ูุญุตู:**
- โ ุฑุณุงูุฉ ุชุฃููุฏ ุชูุตู
- โ Order ูุชุญุฏุซ ูู Shopify
- โ Tag "whatsapp-confirmed" ูุชุถุงู
- โ Status ูุชุญุฏุซ ูู Database

### Test 3: ุงุถุบุท "ุฅูุบุงุก"

1. ุงุนูู Order ุชุงูู
2. ุงุถุบุท "โ ุฅูุบุงุก"

**ุงูููุฑูุถ ูุญุตู:**
- โ ุฑุณุงูุฉ ุฅูุบุงุก ุชูุตู
- โ Order ูุชูุบู ูู Shopify
- โ Status ูุชุญุฏุซ ูู Database

---

## ๐ ุงูู Flow ุงูุชููู:

### Order Creation Flow:
```javascript
Shopify Order Created
  โ
POST /api/shopify/webhook-handler
  โ
handleOrderCreate(order, brand, connection)
  โ
- Save order to shopify_orders table
- Find/create contact
- sendOrderConfirmation()
  โ
  Try: Template Message (moon_order_confirmation)
  Fallback: Interactive Message with Buttons
  โ
WhatsApp Message Sent โ
```

### Button Click Flow:
```javascript
Customer clicks Button
  โ
POST /api/webhook (from WhatsApp)
  โ
Extract button_id (confirm_123 or cancel_123)
  โ
POST /api/shopify/handle-button-click
  โ
handleButtonClick(buttonId, wa_id, phone_number_id)
  โ
- Get brand from phone_number_id
- Get Shopify connection
- Get order from database
  โ
If confirm:
  - confirmShopifyOrder() โ Add tag + note
  - Update database: confirmed_at
  - Send confirmation message
  โ
If cancel:
  - cancelShopifyOrder() โ Cancel order
  - Update database: cancelled_at
  - Send cancellation message
  โ
Done โ
```

---

## ๐ง Troubleshooting:

### ุงููุดููุฉ: ุงูุฑุณุงูุฉ ูุด ุจุชูุตู

**ุงูุญู:**
1. ุชุฃูุฏ ุฅู Template ูุนุชูุฏ ูู Meta
2. ูู ูุด ูุนุชูุฏุ ุงููุธุงู ููุณุชุฎุฏู Interactive Message
3. ุชุฃูุฏ ุฅู WhatsApp Token ุตุญูุญ
4. ุชุฃูุฏ ุฅู Phone Number ID ุตุญูุญ

### ุงููุดููุฉ: Button ูุด ุดุบุงู

**ุงูุญู:**
1. ุชุฃูุฏ ุฅู WhatsApp Webhook ูุถุจูุท
2. ุชุฃูุฏ ุฅู Shopify ูุชุตู
3. ุดูู Logs ูู Vercel

### ุงููุดููุฉ: Shopify ูุด ุจูุชุญุฏุซ

**ุงูุญู:**
1. ุชุฃูุฏ ุฅู Shopify Token ุตุญูุญ
2. ุชุฃูุฏ ุฅู Scopes ุตุญูุญุฉ: read_orders, write_orders
3. ุชุฃูุฏ ุฅู Order ID ุตุญูุญ

---

## ๐ ููุงุญุธุงุช ูููุฉ:

### ุนู Template Messages:

1. **ูุงุฒู ููุงููุฉ Meta** (24 ุณุงุนุฉ)
2. **ุจุนุฏ ุงูููุงููุฉ** ูุดุชุบู ุชููุงุฆูุงู
3. **ูู ูุด ูุนุชูุฏ** ุงููุธุงู ูุณุชุฎุฏู Interactive Message
4. **Template ุฃูุถู** ูุฃูู ูุณูุญ ุจุฅุฑุณุงู ุฃูู ุฑุณุงูุฉ

### ุนู Interactive Messages:

1. **ูุด ูุญุชุงุฌ ููุงููุฉ**
2. **ุจุณ ูุญุชุงุฌ** ุงูุนููู ูุจุฏุฃ ุงููุญุงุฏุซุฉ ุงูุฃูู
3. **ุฃู** ูููู ูู Test Numbers
4. **Buttons ุดุบุงูุฉ** ูู ุงูุญุงูุชูู

### ุนู Shopify Webhooks:

1. **ูุงุฒู HTTPS** (Vercel ุจูููุฑูุง)
2. **Shopify ุจูุจุนุช** POST request
3. **ุงููุธุงู ุจูุณุชูุจู** ููุนุงูุฌ ุชููุงุฆูุงู
4. **ูููุด ุญุงุฌุฉ ูุฏููุฉ**

---

## ๐ ุงูุฎูุงุตุฉ:

**ุงููุธุงู ูุงูู ููุชูุงูู!**

- โ Order Confirmation ุชููุงุฆู
- โ Template Message (ุจุนุฏ ุงูููุงููุฉ)
- โ Interactive Buttons
- โ Shopify Integration ูุงููุฉ
- โ Multi-Brand Support
- โ ุจุฏูู n8n ุฃู ุฃู ุฃุฏูุงุช ุฎุงุฑุฌูุฉ

**ูู ุญุงุฌุฉ ูู ุงููุธุงู ููุณู!** ๐

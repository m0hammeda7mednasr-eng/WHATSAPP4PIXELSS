# ๐ฌ ุฏููู ุงููุชุงุจุนุฉ ุงูุชููุงุฆูุฉ ููุทูุจุงุช

## โจ ุงูููุฒุฉ ุงูุฌุฏูุฏุฉ

ุจุนุฏ ูุง ุงูุนููู ูุฃูุฏ ุงูุทูุจุ ุงููุธุงู ุชููุงุฆูุงู ูุจุนุชูู ุฑุณุงูุฉ ูุชุงุจุนุฉ ุจุนุฏ ุณุงุนุฉ ูุงุญุฏุฉ.

---

## ๐ฏ ููู ุชุดุชุบูุ

### 1๏ธโฃ ุงูุนููู ูุฃูุฏ ุงูุทูุจ
```
ุงูุนููู ูุถุบุท "โ ุชุฃููุฏ"
โ
ุงููุธุงู ูุจุนุช: "ุชู ุชุฃููุฏ ุทูุจู ุจูุฌุงุญ!"
โ
ุงููุธุงู ูุณุฌู ููุช ุงูุชุฃููุฏ ูู Database
```

### 2๏ธโฃ ุจุนุฏ ุณุงุนุฉ ูุงุญุฏุฉ
```
Cron Job ูุดุชุบู ูู 15 ุฏูููุฉ
โ
ูุฏูุฑ ุนูู ุงูุทูุจุงุช ุงููุคูุฏุฉ ูู ุณุงุนุฉ
โ
ูุจุนุช ุฑุณุงูุฉ ูุชุงุจุนุฉ ุชููุงุฆูุฉ
```

### 3๏ธโฃ ุฑุณุงูุฉ ุงููุชุงุจุนุฉ
```
ูุฑุญุจุงู [ุงุณู ุงูุนููู] ๐

ุดูุฑุงู ูุชุฃููุฏู ุทูุจ ุฑูู #1005 ๐

ูุญู ุงูุขู ูุฌูุฒ ุทูุจู ุจุนูุงูุฉุ ูุณูุชู ุงูุชูุงุตู ูุนู 
ูุฑูุจุงู ูุชุฑุชูุจ ููุนุฏ ุงูุชูุตูู ๐

ุฅุฐุง ูุงู ูุฏูู ุฃู ุงุณุชูุณุงุฑุ ูุง ุชุชุฑุฏุฏ ูู ุงูุชูุงุตู ูุนูุง.

ุดูุฑุงู ูุซูุชู ูู [ุงุณู ุงูุจุฑุงูุฏ] ๐
```

---

## โ๏ธ ุงูุฅุนุฏุงุฏ

### ุงูุฎุทูุฉ 1: ุชุญุฏูุซ Database

ููุฐ ุงูู SQL ุฏู ูู Supabase:

```sql
-- Add followup_sent_at column
ALTER TABLE shopify_orders 
ADD COLUMN IF NOT EXISTS followup_sent_at TIMESTAMPTZ;

-- Add index for faster queries
CREATE INDEX IF NOT EXISTS idx_orders_followup 
ON shopify_orders(confirmation_status, followup_sent_at, confirmed_at)
WHERE confirmation_status = 'confirmed' AND followup_sent_at IS NULL;
```

**ููู:**
1. ุงูุชุญ Supabase Dashboard
2. SQL Editor
3. ุงูุตู ุงูููุฏ
4. Run

---

### ุงูุฎุทูุฉ 2: ุฅุถุงูุฉ Cron Secret

ูู Vercel Dashboard:

1. Settings โ Environment Variables
2. ุฃุถู ูุชุบูุฑ ุฌุฏูุฏ:
   ```
   Name: CRON_SECRET
   Value: [ุฃู ูููุฉ ุณุฑ ูููุฉ - ูุซูุงู: cron_secret_2024_xyz]
   ```
3. Save

---

### ุงูุฎุทูุฉ 3: ุชูุนูู Cron Job

ุงูู Cron Job ููุฌูุฏ ูู:
```
api/cron/send-order-followup.js
```

Vercel ููุดุบูู ุชููุงุฆูุงู ูู 15 ุฏูููุฉ (ูู `vercel.json`).

**ููุชุฃูุฏ:**
1. Vercel Dashboard โ Settings โ Crons
2. ูุงุฒู ุชูุงูู: `/api/cron/send-order-followup`
3. Schedule: `*/15 * * * *` (ูู 15 ุฏูููุฉ)

---

## ๐งช ุงุฎุชุจุงุฑ ุงูููุฒุฉ

### ุงูุทุฑููุฉ 1: ุงุฎุชุจุงุฑ ูุฏูู

```bash
node test-followup.js
```

### ุงูุทุฑููุฉ 2: ุงุฎุชุจุงุฑ ูู Vercel

1. ุงูุชุญ: `https://wahtsapp2.vercel.app/api/cron/send-order-followup`
2. ูู Headers ุฃุถู:
   ```
   Authorization: Bearer [CRON_SECRET]
   ```
3. ูุงุฒู ูุฑุฌุน:
   ```json
   {
     "success": true,
     "total": 1,
     "sent": 1,
     "failed": 0
   }
   ```

---

## ๐ ูุชุงุจุนุฉ ุงูู Cron Jobs

### ูู Vercel Dashboard:

1. Logs โ Filter by "cron"
2. ุดูู ุขุฎุฑ ุชุดุบูู
3. ุชุฃูุฏ ูู:
   ```
   โ Running order follow-up cron job...
   โ Found X orders needing follow-up
   โ Follow-up sent for order #1005
   โ Cron job completed: 1 sent, 0 failed
   ```

### ูู Supabase:

```sql
-- ุดูู ุงูุทูุจุงุช ุงููู ุงุชุจุนุชููุง follow-up
SELECT 
  shopify_order_number,
  confirmation_status,
  confirmed_at,
  followup_sent_at
FROM shopify_orders
WHERE followup_sent_at IS NOT NULL
ORDER BY followup_sent_at DESC;
```

---

## ๐จ ุชุฎุตูุต ุฑุณุงูุฉ ุงููุชุงุจุนุฉ

ุนุฏู ุงูุฑุณุงูุฉ ูู `api/cron/send-order-followup.js`:

```javascript
const followupMessage = `ูุฑุญุจุงู ${contact.name} ๐

[ุฑุณุงูุชู ุงููุฎุตุตุฉ ููุง]

ุดูุฑุงู ูุซูุชู ูู ${brand.name} ${brand.brand_emoji}`;
```

---

## โฐ ุชุบููุฑ ุงูุชูููุช

### ูู ุนุงูุฒ ุงููุชุงุจุนุฉ ุจุนุฏ 2 ุณุงุนุฉ ุจุฏู ุณุงุนุฉ:

ูู `api/cron/send-order-followup.js`:

```javascript
// ุจุฏู:
const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000).toISOString();

// ุงุณุชุฎุฏู:
const twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString();
```

### ูู ุนุงูุฒ ุงูู Cron ูุดุชุบู ูู ุณุงุนุฉ ุจุฏู ูู 15 ุฏูููุฉ:

ูู `vercel.json`:

```json
"crons": [
  {
    "path": "/api/cron/send-order-followup",
    "schedule": "0 * * * *"
  }
]
```

---

## ๐ง ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ: ูููุด ุฑุณุงุฆู ุจุชุชุจุนุช

**ุงูุญู:**

1. ุชุฃูุฏ ูู `CRON_SECRET` ููุฌูุฏ ูู Vercel
2. ุชุฃูุฏ ูู ุงูู column `followup_sent_at` ููุฌูุฏ ูู Database
3. ุดูู Vercel Logs ููุฃุฎุทุงุก

### ุงููุดููุฉ: ุงูุฑุณุงุฆู ุจุชุชุจุนุช ุฃูุชุฑ ูู ูุฑุฉ

**ุงูุญู:**

ุชุฃูุฏ ูู ุงูู index ููุฌูุฏ:
```sql
CREATE INDEX IF NOT EXISTS idx_orders_followup 
ON shopify_orders(confirmation_status, followup_sent_at, confirmed_at)
WHERE confirmation_status = 'confirmed' AND followup_sent_at IS NULL;
```

### ุงููุดููุฉ: Token ููุชูู

**ุงูุญู:**

ุญุฏุซ ุงูู Token ูู CRM Settings (ุงุณุชุฎุฏู Permanent Token).

---

## ๐ Checklist

ูุจู ูุง ุชุดุบู ุงูููุฒุฉ:

- [ ] Column `followup_sent_at` ูุถุงู ูู Database
- [ ] Index ููุฌูุฏ
- [ ] `CRON_SECRET` ูุถุงู ูู Vercel
- [ ] Cron Job ููุนู ูู Vercel
- [ ] WhatsApp Token ุตุงูุญ (Permanent)
- [ ] ุงุฎุชุจุฑุช ุงูููุฒุฉ ุจู test order

---

## ๐ฏ ุงูุฎูุงุตุฉ

**ุงูููุฒุฉ ุฏู ุจุชุนูู:**
- โ ูุชุงุจุนุฉ ุชููุงุฆูุฉ ุจุนุฏ ุณุงุนุฉ ูู ุงูุชุฃููุฏ
- โ ุฑุณุงูุฉ ุดูุฑ ูุชุทููู ููุนููู
- โ ุชุญุณูู ุชุฌุฑุจุฉ ุงูุนููู
- โ ุฒูุงุฏุฉ ุงูุซูุฉ ูู ุงูุจุฑุงูุฏ

**ูุด ูุญุชุงุฌ ุชุนูู ุญุงุฌุฉ ูุฏูู:**
- ุงููุธุงู ูุดุชุบู ุชููุงุฆูุงู
- Cron Job ูุฏูุฑ ูู 15 ุฏูููุฉ
- ุงูุฑุณุงุฆู ุชุชุจุนุช ููุญุฏูุง

---

## ๐ ููุฒุฉ ุฅุถุงููุฉ: ุฅุฎูุงุก ุฒุฑุงุฑ ุงูุฅูุบุงุก

ูู ุงูุนููู ูุบู ุทูุจ ูุจู ูุฏูุ ุงููุธุงู ุชููุงุฆูุงู:
- โ ูุชุญูู ูู ุญุงูุฉ ุงูุทูุจ
- โ ูููุน ุงูุฅูุบุงุก ุงููุชูุฑุฑ
- โ ูุจุนุช ุฑุณุงูุฉ ูุงุถุญุฉ

**ุงูููุฏ ููุฌูุฏ ูู:**
`api/webhook.js` โ `handleButtonClickAction()`

---

**๐ ุชู! ุงููุธุงู ุฌุงูุฒ ูููุชุงุจุนุฉ ุงูุชููุงุฆูุฉ**

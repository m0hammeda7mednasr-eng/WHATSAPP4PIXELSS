# ๐ง ุญู ูุดููุฉ ุงูุจูุชููุงุช ูุด ุดุบุงูุฉ ุฎุงูุต

## ๐ ุงููุดููุฉ
ุงูุจูุชููุงุช ูุด ุจุชุดุชุบู ุฎุงูุต ููุด ุจุชุญุฏุซ ุญุงุฌุฉ ูู:
- โ Settings (ูุด ุจุชุญูุธ)
- โ Shopify (ูุด ุจูุชุนูู fulfillment ุฃู tags)
- โ Database (ูุด ุจูุชุญุฏุซ)

## ๐ฏ ุงูุฃุณุจุงุจ ุงููุญุชููุฉ

### 1. ูุดููุฉ ูู Supabase Key
**ุงููุดููุฉ:** ุงูููุฏ ูุงู ุจูุญุงูู ูุณุชุฎุฏู `SUPABASE_SERVICE_ROLE_KEY` ุงููู ูุด ููุฌูุฏ.

**ุงูุญู:** ุชู ุชุบููุฑู ูู `VITE_SUPABASE_ANON_KEY` ุงููู ููุฌูุฏ ูู Vercel.

```javascript
// โ ูุจู
const SUPABASE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.VITE_SUPABASE_ANON_KEY;

// โ ุจุนุฏ
const SUPABASE_KEY = process.env.VITE_SUPABASE_ANON_KEY || process.env.SUPABASE_ANON_KEY;
```

---

### 2. ูุดููุฉ ูู Webhook Handler
**ุงููุดููุฉ:** ุงูู webhook ูููู ูุด ุจูุณุชูุจู ุงูู button clicks ุฃุตูุงู.

**ุงูุญู:** ุชู ุฅุถุงูุฉ logging ููุตู ุนุดุงู ูุดูู ุฅูู ุงููู ุจูุญุตู.

---

### 3. ูุดููุฉ ูู Database Permissions
**ุงููุดููุฉ:** ุงูู RLS (Row Level Security) ูููู ูููุน ุงูุชุญุฏูุซุงุช.

**ุงูุญู:** ุชุฃูุฏ ูู ุงูู Policies ูู Supabase.

---

## โ ุงูุชุญุฏูุซุงุช ุงููู ุงุชุนููุช

### 1. ุชุตููุญ Supabase Key
**ุงูููู:** `api/shopify/handle-button-click.js`

```javascript
const SUPABASE_URL = process.env.VITE_SUPABASE_URL || process.env.SUPABASE_URL;
const SUPABASE_KEY = process.env.VITE_SUPABASE_ANON_KEY || process.env.SUPABASE_ANON_KEY;

if (!SUPABASE_URL || !SUPABASE_KEY) {
  console.error('โ Missing Supabase credentials');
}

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
```

---

### 2. ุฅุถุงูุฉ Logging ููุตู
**ุงูููู:** `api/shopify/handle-button-click.js`

ุงูุขู ุงูููุฏ ุจูุทุจุน:
- โ Button clicked details
- โ Parsed action and order ID
- โ Brand lookup result
- โ Shopify connection status
- โ Order lookup result
- โ Shopify API calls
- โ Database updates
- โ WhatsApp message sending
- โ Any errors with full stack trace

---

## ๐งช ุฎุทูุงุช ุงูุชุดุฎูุต

### ุงูุฎุทูุฉ 1: ุชุฃูุฏ ูู Environment Variables

ูู Vercel โ Settings โ Environment Variables:

```
โ VITE_SUPABASE_URL = https://xxx.supabase.co
โ VITE_SUPABASE_ANON_KEY = eyJhbGc...
โ WEBHOOK_VERIFY_TOKEN = whatsapp_crm_2024
```

---

### ุงูุฎุทูุฉ 2: ุชุฃูุฏ ูู Database

ูู Supabase โ SQL Editor:

```sql
-- 1. ุชุฃูุฏ ูู ูุฌูุฏ Brand
SELECT id, name, phone_number_id, whatsapp_token 
FROM brands 
WHERE phone_number_id = 'YOUR_PHONE_NUMBER_ID';

-- 2. ุชุฃูุฏ ูู Shopify Connection
SELECT * FROM shopify_connections 
WHERE brand_id = 'YOUR_BRAND_ID' 
AND is_active = true;

-- 3. ุชุฃูุฏ ูู Order
SELECT * FROM shopify_orders 
WHERE shopify_order_id = 'YOUR_ORDER_ID';
```

---

### ุงูุฎุทูุฉ 3: ุชุฃูุฏ ูู RLS Policies

ูู Supabase โ Authentication โ Policies:

#### ููู `shopify_orders` table:

```sql
-- Policy ููู UPDATE
CREATE POLICY "Allow update shopify_orders"
ON shopify_orders
FOR UPDATE
USING (true)
WITH CHECK (true);

-- ุฃู ุนูู ุงูุฃูู:
CREATE POLICY "Allow update own brand orders"
ON shopify_orders
FOR UPDATE
USING (brand_id IN (SELECT id FROM brands))
WITH CHECK (brand_id IN (SELECT id FROM brands));
```

---

### ุงูุฎุทูุฉ 4: ุดูู Vercel Logs

1. ุงุฏุฎู ุนูู Vercel Dashboard
2. ุงุฎุชุงุฑ ุงููุดุฑูุน
3. ุงุถุบุท ุนูู **Functions**
4. ุฏูุฑ ุนูู `/api/webhook/whatsapp`
5. ุดูู ุงูู Logs

**ูู ุดุบุงู ุตุญุ ูุชูุงูู:**
```
๐ Button clicked: { buttonId: 'confirm_123', wa_id: '201234567890', phone_number_id: '123456789' }
๐ Parsed action: confirm Order ID: 123
๐ Looking for brand with phone_number_id: 123456789
โ Brand found: Moon ID: abc-123
๐ Looking for Shopify connection for brand: abc-123
โ Shopify connected: moon-store.myshopify.com
๐ Looking for order: 123 for brand: abc-123
โ Order found: #1234
โ Confirming order...
๐ Confirming and fulfilling order: 123
โ Order confirmed and fulfilled successfully
๐ Updating order status in database...
โ Order status updated
๐ค Sending confirmation message...
โ Confirmation message sent
โ Order updated successfully: confirm
```

**ูู ููู ูุดููุฉุ ูุชูุงูู:**
```
โ Brand not found for phone_number_id: 123456789
// ุฃู
โ Shopify not connected for brand: abc-123
// ุฃู
โ Order not found: 123
// ุฃู
โ Failed to update order status: { message: '...' }
```

---

## ๐ง ุงูุญููู ุญุณุจ ุงููุดููุฉ

### ุงููุดููุฉ: Brand not found
**ุงูุญู:**
```sql
-- ุฃุถู Brand ูู Supabase
INSERT INTO brands (name, phone_number_id, whatsapp_token)
VALUES ('Moon', 'YOUR_PHONE_NUMBER_ID', 'YOUR_WHATSAPP_TOKEN');
```

---

### ุงููุดููุฉ: Shopify not connected
**ุงูุญู:**
1. ุงุฏุฎู ุนูู Settings ูู ุงููููุน
2. ุงุถุบุท ุนูู Shopify Settings
3. ุงุนูู Connect to Shopify
4. ุฃููู OAuth

---

### ุงููุดููุฉ: Order not found
**ุงูุญู:**
- ุชุฃูุฏ ุฅู ุงูู Order ID ูู ุงูู button payload ุตุญูุญ
- ุชุฃูุฏ ุฅู ุงูู Order ููุฌูุฏ ูู `shopify_orders` table
- ุชุฃูุฏ ุฅู ุงูู `shopify_order_id` ูุทุงุจู

---

### ุงููุดููุฉ: Failed to update order status
**ุงูุญู:**
```sql
-- ุชุฃูุฏ ูู RLS Policies
-- ูู Supabase โ Table Editor โ shopify_orders โ RLS

-- ุนุทูู RLS ูุคูุชุงู ููุงุฎุชุจุงุฑ:
ALTER TABLE shopify_orders DISABLE ROW LEVEL SECURITY;

-- ูู ุงุดุชุบูุ ูุจูู ุงููุดููุฉ ูู ุงูู Policies
-- ุฃุถู Policy ุตุญูุญ:
CREATE POLICY "Allow all operations on shopify_orders"
ON shopify_orders
FOR ALL
USING (true)
WITH CHECK (true);
```

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

### 1. ุงุฑูุน ุงูุชุญุฏูุซุงุช
```bash
git add .
git commit -m "Fix button handler - add detailed logging and fix Supabase key"
git push origin main
```

### 2. ุงูุชุธุฑ Deployment
- ุงูุชุญ Vercel Dashboard
- ุชุฃูุฏ ูู ูุฌุงุญ ุงูู deployment

### 3. ุงุฎุชุจุฑ ุงูุจูุชููุงุช
- ุงุนูู ุทูุจ ุฌุฏูุฏ ูู Shopify
- ุงุถุบุท ุนูู ุฒุฑ "ุชุฃููุฏ" ุฃู "ุฅูุบุงุก"
- ุดูู Vercel Logs

### 4. ุดูู ุงููุชุงุฆุฌ
- ุชุฃูุฏ ูู ุชุญุฏูุซ Database
- ุชุฃูุฏ ูู ุชุญุฏูุซ Shopify
- ุชุฃูุฏ ูู ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุชุฃููุฏ

---

## ๐ Test Script

ุงุณุชุฎุฏู ุงูู test script ุนุดุงู ุชุฎุชุจุฑ:

```bash
node test-button-now.js
```

ุชุฃูุฏ ุฅูู ุนุฏูุช:
- `phone_number_id`
- `wa_id` (ุฑูู ุงูุนููู)
- `order ID`
- `vercelUrl`

---

## ๐ฏ ุงููุชูุฌุฉ ุงููุชููุนุฉ

ุจุนุฏ ุงูุชุญุฏูุซุงุช:
- โ ุงูุจูุชููุงุช ุชุดุชุบู
- โ Database ูุชุญุฏุซ
- โ Shopify ูุชุญุฏุซ
- โ ุฑุณุงุฆู ุงูุชุฃููุฏ ุชุชุจุนุช
- โ Logs ูุงุถุญุฉ ูููุตูุฉ

---

## ๐ ูู ูุณู ูุด ุดุบุงู

ุดุงุฑู ูุนุงูุง:
1. Screenshot ูู Vercel Logs
2. ูุชูุฌุฉ ุงูู SQL queries
3. Screenshot ูู Settings ูู ุงููููุน
4. Screenshot ูู ุงูุฑุณุงูุฉ ุนูู ุงููุงุชุณุงุจ

---
ุชู ุงูุชุญุฏูุซ: ${new Date().toLocaleString('ar-EG')}
